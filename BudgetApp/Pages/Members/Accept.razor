@page "/members/accept/{token}"
@using BudgetApp.Data
@using BudgetApp.Models
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity

@inject ApplicationDbContext Db
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager Nav

<h3>Dołączanie do rodziny</h3>

@if (error != null)
{
    <div class="alert alert-danger">@error</div>
}
else if (success)
{
    <div class="alert alert-success">Dołączono do rodziny!</div>
}
else
{
    <p>Proszę czekać…</p>
}

@code {
    [Parameter] public string token { get; set; } = "";
    private string? error;
    private bool success;

    protected override async Task OnInitializedAsync()
    {
        var invite = await Db.Invites.FindAsync(token);
        if (invite == null) { error = "Nieprawidłowy lub wygasły link."; return; }

        var auth = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(auth.User)
                   ?? throw new InvalidOperationException("Brak użytkownika.");

        user.FamilyId = invite.FamilyId;
        await UserManager.UpdateAsync(user);

        // opcjonalnie: usuń zaproszenie
        Db.Invites.Remove(invite);
        await Db.SaveChangesAsync();

        success = true;
    }
}
